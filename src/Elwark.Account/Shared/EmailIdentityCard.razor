@using Elwark.Account.Service.Profile.Models
@using Elwark.Account.Service.Profile.Requests
@using Microsoft.AspNetCore.Components
@using Microsoft.Extensions.Localization

<MudCard>
    <MudCardHeader>
        <CardHeaderAvatar>
            <MudAvatar Style="background: #FFB800">
                <MudIcon Icon="@Icons.Material.Filled.AlternateEmail"/>
            </MudAvatar>
        </CardHeaderAvatar>
        <CardHeaderContent>
            <MudText Typo="Typo.body1">Email</MudText>
            @if (Email.IsConfirmed)
            {
                <MudText Typo="Typo.body2" Color="Color.Success">
                    @L["Confirmed"]
                </MudText>
            }
            else
            {
                <MudText Typo="Typo.body2" Color="Color.Error">
                    @L["NotConfirmed"]
                </MudText>
            }
        </CardHeaderContent>
        <CardHeaderActions>
            @if (!Email.IsPrimary)
            {
                <MudMenu Direction="Direction.Left" OffsetX="true" Icon="@Icons.Material.Filled.MoreVert">
                    <MudMenuItem OnClick="OnDeleteClick">@L["Delete"]</MudMenuItem>
                </MudMenu>
            }
        </CardHeaderActions>
    </MudCardHeader>
    <MudCardContent>
        <MudText Typo="Typo.subtitle1">
            <strong>
                @Email.Value
            </strong>
        </MudText>
        @if (Email.IsConfirmed && Email.IsPrimary)
        {
            <MudText>
                @L["PrimaryEmail"]
            </MudText>
        }
        else if (Email.IsConfirmed)
        {
            <MudButton Class="mt-3" Variant="Variant.Filled" Color="Color.Primary" OnClick="@OnSetPrimaryClick" Disabled="@_isLoading">
                @if (_isLoading)
                {
                    <div class="d-flex flex-row align-center">
                        <MudProgressCircular Class="mr-3" Size="Size.Small" Indeterminate="true"/>
                        @L["Loading"]
                    </div>
                }
                else
                {
                    @L["SetAsPrimaryEmail"]
                }
            </MudButton>
        }
        else
        {
            <MudButton Class="mt-3" Variant="Variant.Filled" Color="Color.Primary" OnClick="@OnConfirmationClick" Disabled="@_isLoading">
                @if (_isLoading)
                {
                    <div class="d-flex flex-row align-center">
                        <MudProgressCircular Class="mr-3" Size="Size.Small" Indeterminate="true"/>
                        @L["Loading"]
                    </div>
                }
                else
                {
                    @L["Confirm"]
                }
            </MudButton>
        }
    </MudCardContent>
</MudCard>

@code {

    private bool _isLoading;

    [Inject]
    IStringLocalizer<App> L { get; set; } = default!;

    [Parameter]
    public EmailConnection Email { get; set; } = default!;

    [Parameter]
    public EventCallback<Connection> OnDelete { get; set; }

    [Parameter]
    public EventCallback<EmailConnection> OnConfirmation { get; set; }

    [Parameter]
    public EventCallback<EmailConnection> OnSetPrimary { get; set; }

    private async Task OnDeleteClick()
    {
        await OnDelete.InvokeAsync(Email);
    }

    private async Task OnConfirmationClick()
    {
        _isLoading = true;
        await OnConfirmation.InvokeAsync(Email);
        _isLoading = false;
    }

    private async Task OnSetPrimaryClick()
    {
        _isLoading = true;
        await OnSetPrimary.InvokeAsync(Email);
        _isLoading = false;
    }

}
